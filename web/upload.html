<!DOCTYPE html>

<script type="text/javascript">
 //http://oa.ncschina.com/seeyon/fileUpload.do?type=0&applicationCategory=1&extensions=&maxSize=&isEncrypt=true&popupTitleKey=&isA8geniusAdded=false&quantity=5&callback=addCkEditorAttachment&firstSave=true&_isModalDialog=true

  var _ctxPath = '/seeyon', _ctxServer = 'http://oa.ncschina.com:80/seeyon';
  var _locale = 'zh_CN',_isDevelop = false,_sessionid = '1AB0E8015D15FC122459BD190203BE16',_isModalDialog = false;
  
  _isModalDialog = true;
  
  var _resourceCode = "";
  var seeyonProductId="2";
</script>
<link rel="stylesheet" href="/seeyon/common/all-min.css?V=V5_0SP2_2014-08-26">

<link rel="stylesheet" href="/seeyon/skin/default/skin.css?V=V5_0SP2_2014-08-26">


<script type="text/javascript" src="/seeyon/i18n_zh_CN.js?V=V5_0SP2_2014-08-26"></script>

<script type="text/javascript" src="/seeyon/common/all-min.js?V=V5_0SP2_2014-08-26"></script>

<script type="text/javascript" src="/seeyon/common/js/ui/calendar/calendar-zh_CN.js?V=V5_0SP2_2014-08-26"></script>

<script type="text/javascript" src="/seeyon/main.do?method=headerjs&login=-1542691246"></script>
<script type="text/javascript">
$.ctx._currentPathId = 'fileUpload_index';
$.ctx._pageSize = 20;
$.ctx.fillmaps = null;
</script>
<script type="text/javascript" src="/seeyon/ajax.do?managerName=knowledgeFavoriteManager"></script>









<link rel="stylesheet" type="text/css" href="/seeyon/common/css/default.css?V=V5_0SP2_2014-08-26">
<link href="/seeyon/common/skin/default/skin.css?V=V5_0SP2_2014-08-26" type="text/css" rel="stylesheet"><script type="text/javascript">var skinType = '/seeyon/common/skin/default';</script>
<script type="text/javascript" charset="UTF-8" src="/seeyon/common/js/v3x-debug.js"></script>
<script type="text/javascript">
<!--
var v3x = new V3X();
v3x.init("/seeyon", "zh-cn");
_ = v3x.getMessage;

v3x.loadLanguage("/apps_res/v3xmain/js/i18n");
var genericControllerURL = "";


var colGeneralURL = "";
var edocGeneralURL =  "";
//-->
</script>




<html style="height: 100%">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>上传本地文件</title>
<link rel="stylesheet" href="/seeyon/common/all-min.css">
<link rel="stylesheet" href="/seeyon/skin/default/skin.css">


<script type="text/javascript">//Attachment(id, reference, subReference, category, type, filename, mimeType, createDate, size, fileUrl, description){
//debugger;
//判断是否安装了精灵
var isA8geniusAdded = false;





var number = 0;
function checks(){
    if(number == 0 || files.isEmpty()){
        //return false;
        return ;
    }
    
    $("#b1").disable();

    show();
    
    for(var i = 1; i <= index; i++){
        var o = document.getElementById("file" + i);
        if(!o){
            continue;
        }

        if(!o.value){
            document.getElementById("fileInputDiv" + i).parentNode.removeChild(document.getElementById("fileInputDiv" + i));
        }
    }
    document.getElementById('form_upload').submit();
    //return true;

}

function checkExtensions(obj){
    var filepath = obj.value;
    if (!filepath) {
        return false;
    }
    
    var extensionstr = document.getElementById("extensions").value;
    if(!extensionstr){
        return true;
    }

    var lastSeparator = filepath.lastIndexOf(".");
    if (lastSeparator == -1) {
        return true;
    }
    else{
        if(extensionstr){
            var extension = filepath.substring(lastSeparator + 1).toLowerCase();
            var extensions = extensionstr.split(",");
            
            for(var i=0; i<extensions.length; i++) {
                if(extensions[i] == extension){
                    return true;
                }
            }
        }
    }
    
    alert("不支持的文件扩展名。支持:");
    
    return false;
}

function show(){
    //document.getElementById("b1").disabled = true;

    document.getElementById("upload1").style.display = "none";
    document.getElementById("uploadprocee").style.display = "";
/*     if(isA8geniusAdded){
        document.getElementById("selectFile").style.display = "none";     
        document.getElementById("fileProcee").style.display = "";  
    } */
}

function addAttachment(type, filename, mimeType, createDate, size, fileUrl, canDelete, needClone,extension,icon,v){
    var _parent = window.opener;
    if(_parent == null){
        _parent = window.dialogArguments;
    }
    var callback = null;
    
        if(_parent.addCkEditorAttachment) callback = _parent.addCkEditorAttachment;
          

    if(callback){
        callback(type, filename, mimeType, createDate, size, fileUrl, canDelete, needClone,'',extension,icon,null,null,false,v);
    }else{
        _parent.addAttachment(type, filename, mimeType, createDate, size, fileUrl, canDelete, needClone,'',extension,icon,null,'1',false,null,false,false,v); 
    }
     
    //根据这个变量来判断是否选择了附件。
    if(typeof(_parent.hasUploadAtt)!= 'undefined') _parent.hasUploadAtt=true;
        
}

function addAttachmentPoi(type, filename, mimeType, createDate, size, fileUrl, canDelete, needClone,extension,icon,poi, reference, category, onlineView, width, embedInput,hasSaved,isCanTransform,v,canFavourite, isShowImg){
  var _parent = window.opener;
  if(_parent == null){
      _parent = window.dialogArguments;
  }
  _parent.addAttachmentPoi(type, filename, mimeType, createDate, size, fileUrl, canDelete, needClone,'',extension,icon,poi, reference, category, onlineView, width, embedInput,hasSaved,isCanTransform,v,canFavourite, isShowImg); 

  //根据这个变量来判断是否选择了附件。
  if(typeof(_parent.hasUploadAtt)!= 'undefined') _parent.hasUploadAtt=true;
  if(!isA8geniusAdded){
      window.close();
  }           
}

function callforward(fileurls,repeat){
  
     
}
function listenerKeyPress(){
    if(event.keyCode == 27){
        window.close();
    }
}

function again(){
    //document.getElementById("b1").disabled = false;
    $("#b1").enable(); 
    document.getElementById("upload1").style.display = "";
    document.getElementById("uploadprocee").style.display = "none";
    if(isA8geniusAdded){
        document.getElementById("selectFile").style.display = "none";     
        document.getElementById("fileProcee").style.display = "";  
    }
    
    number = 0;
    files.clear();
    
    document.getElementById("fileNameDiv").innerHTML = " <li><a>&nbsp;</a></li>";
    document.getElementById("fileInputDiv").innerHTML = "";
    
    addInput(index);
}
var quantity = 9999;
// 参数限制文件数小于5时，安装了精灵也受控，否则不受参数限制
var paramQuantity = 5;
if(isA8geniusAdded){
    quantity = (paramQuantity<5)?paramQuantity:quantity;
}else{
    quantity = paramQuantity;
}
var index = 1;

var files = new Properties();
var geniusNum = 0;


function addNextInput(obj){
    if(files.values().contains(obj.value)){
        removeInput(index);
        addInput(index);

        alert('您选择文件已经存在!');
        return false;
    }

    if(!checkExtensions(obj)){
        removeInput(index);
        addInput(index);
        
        return false;
    }

    if( number >= quantity){
        removeInput(index);
        addInput(index);
        
        alert($.i18n("fileupload.uploading.upload_alert_limit").format(number));
        //alert('您一次最多选择{0}个文件！');
        return false;
    }

    number++;
    document.getElementById("fileInputDiv" + index).style.display = 'none';
    var s = obj.value.lastIndexOf("\\");
    if(s < 0){
        s = obj.value.lastIndexOf("/");
    }
    var filename = obj.value.substring(s + 1);
    var nameHTML = "";
    //<li><span title="图片上传的附件.jpg">图片上传的附件.jpg</span><em class="ico16 revoked_process_16"></em></li>
    nameHTML += "<li id='fileNameDiv" + index + "' class='margin_r_10'>"
    nameHTML += "<span title='"+escapeStringToHTML(filename)+"'>"
    nameHTML += filename.getLimitLength(16).escapeHTML();
    nameHTML += "</span>"
    nameHTML += "<em  onclick='deleteOne(" + index + ")' class='ico16 affix_del_16' title='刪除'></em>";      
    nameHTML += "</li>";

    document.getElementById("fileNameDiv").innerHTML += nameHTML;
    files.put(index, obj.value);
    index++;
    addInput(index);
    return true;
}

function deleteOne(i){
    var pos = getIndex(i);
    removeInput(i); 
    if(!isA8geniusAdded){
      number-- ;  
    }
    files.remove(i);
    
}

function removeInput(i){

    var errorNode = false;
    var pos = getIndex(i);
    try{
        document.getElementById("fileInputDiv" + i).parentNode.removeChild(document.getElementById("fileInputDiv" + i));
    }
    catch(e){
        errorNode = true;
    }
        
    try{
        document.getElementById("fileNameDiv" + i).parentNode.removeChild(document.getElementById("fileNameDiv" + i));
    }
    catch(e){
       errorNode = true;
    }

    if(isA8geniusAdded&&!errorNode){
        var UFIDA_Upload1 = document.getElementById("UFIDA_Upload1");
        UFIDA_Upload1.DeleteItemFromList(i-1);     
        number--; 
    }
   
}

function addInput(i){
    //var html =  "<div id=\"fileInputDiv" + i + "\" class=\"file_unload clearfix\" style=\"\">" + "</div>";
    var e = document.createElement("div");
    e.setAttribute("id","fileInputDiv" + i);
    e.className = "file_unload clearfix";
    var fileNameIndexFlag = i;
    if(quantity==1)fileNameIndexFlag = 1;
    if(isA8geniusAdded){        
        var inputHTML1 = "";  
        inputHTML1+="<a class=\"common_button common_button_icon file_click\" href=\"###\"><em class=\"ico16 affix_16\"></em>添加";
        inputHTML1+="<INPUT type=\"text\" name=\"file1\" id=\"file1\" onkeydown=\"return false\" onkeypress=\"return false\" style=\"width: 73%\">" + "<INPUT type=\"button\" name=\"button1\" id=\"button1\" onclick=\"OpenBrowser()\" value=\"浏览......\" >";
        inputHTML1+="</a>";
        e.innerHTML=inputHTML1;
    }else{
        //var eInput;
/*         if(navigator.userAgent.indexOf("MSIE")>0){
             var inputHTML = "<INPUT type=\"file\" name=\"file" + fileNameIndexFlag + "\" id=\"file" + i + "\" onchange=\"addNextInput(this)\" onkeydown=\"return false\" onkeypress=\"return false\" style=\"width: 100%\">";
             eInput = document.createElement(inputHTML);     
        } else { */
          
        var inputHTML1 = "";  
        inputHTML1+="<a class=\"common_button common_button_icon file_click\" href=\"###\"><em class=\"ico16 affix_16\"></em>添加";
        inputHTML1+= "<INPUT type=\"file\" name=\"file" + fileNameIndexFlag + "\" id=\"file" + i + "\" onchange=\"addNextInput(this)\" onkeydown=\"return false\" onkeypress=\"return false\" style=\"width: 100%\"/>";
        inputHTML1+="</a>";
        e.innerHTML=inputHTML1;
          
        /*
            eInput = document.createElement("input");
            eInput.setAttribute("type","file");
            eInput.setAttribute("name","file" + fileNameIndexFlag);
            eInput.setAttribute("id","file" + i);
            eInput.setAttribute("onchange","addNextInput(this)");
            eInput.setAttribute("onkeydown","return false");
            eInput.setAttribute("onkeypress","return false");
            eInput.setAttribute("style","width:100%");
            */
            
/*         } */
        //e.appendChild(eInput);
    }
    document.getElementById("fileInputDiv").appendChild(e);
}

function OpenBrowser()
{
    try{
    /*
    for(i=index-1;i>0;i--){
        deleteOne(i);
    }
    files = new Properties();
*/    
    var UFIDA_Upload1 = document.getElementById("UFIDA_Upload1");
    var maxSize = "52428800";
    if(maxSize){
        UFIDA_Upload1.SetLimitFileSize(parseInt(maxSize));
    }
    var ret = UFIDA_Upload1.openBrowser();
    document.getElementById("file1").value = ret;       
    var fStrs = ret.split("\n");
    var i = 0;
    for(;i<fStrs.length;i++){
        document.getElementById("fileStr").value = fStrs[i];
        if(!addNextInput(document.getElementById("fileStr")))break;
    }
    for(;i<fStrs.length;i++){
        UFIDA_Upload1.DeleteItemFromList(i-1);  
    }
}catch(e){
    alert("精灵版本不匹配！请卸载当前精灵，从登录页安装新版本。");
}
}
// 根据fileInputDiv的后缀数字获取它在数组中的位置
function getIndex(index)
{
    var name = 'fileNameDiv' + index;
    var container = document.getElementById("fileNameDiv");
    var children = container.getElementsByTagName('div');
    var len = children.length;
    var result = 0;
    for(i = 0;i<len;i++)
    {
        var element = children[i];      
        result ++;
        if(name == element.id ) 
        {
            return result;
        }

    }
    return -1;
}
function SetServerName_OnClick()
{
    try{
        var form_action= document.getElementById("form_action");        
        var extensions = document.getElementById("extensions").value;
        var applicationCategory = document.getElementById("applicationCategory").value;
        var destDirectory = document.getElementById("destDirectory").value;
        var destFilename = document.getElementById("destFilename").value;
        var typeStr = document.getElementById("type").value;
        var maxSizeStr = document.getElementById("maxSize").value;

        var repeat = "0";
        try{
            var repeats = document.getElementsByName("repeat");
            for(var i = 0; i < repeats.length; i ++){
                if(repeats[i].checked){
                    repeat = repeats[i].value;
                    break;
                }else{
                    continue;
                }
            }
        }catch(e){}
        
        var isOldUFIDA_Upload1 = true;
        try{
            var ufa = new ActiveXObject("UFIDA_IE_Addin.Assistance");
            if(ufa.getGeniusVersion() != null){
                isOldUFIDA_Upload1 = false;
            }
        }
        catch(e){
        }
        var serverName = null;
        if(isOldUFIDA_Upload1){
            serverName = 'oa.ncschina.com';
        }
        else{
            serverName = 'http://oa.ncschina.com';
        }
        
        var fieldname= "id=&method=processUpload&extensions="+extensions
                       +"&applicationCategory="+applicationCategory
                       +"&destDirectory="+destDirectory
                       +"&type="+typeStr
                       +"&maxSize="+maxSizeStr
                       +"&from=a8genius&repeat=" + repeat
                       +"&destFilename="+destFilename.replace(/\\/g,"/");
        
        fieldname += "&firstSave=true"
         
    
        var UFIDA_Upload1 = document.getElementById("UFIDA_Upload1");
        UFIDA_Upload1.CallBackUploadCompletedType(1);
        var serverPort = '80';
        UFIDA_Upload1.SetServerName(serverName);
        UFIDA_Upload1.SetFormAction(form_action.value);
        UFIDA_Upload1.SetFileFieldName("file1");
        UFIDA_Upload1.SetFieldName(fieldname);
        UFIDA_Upload1.SetCallbackUploadCompleted(cbmthod);
        UFIDA_Upload1.SetServerPort(serverPort);
        UFIDA_Upload1.SetProcessBarColor(250206135);
        UFIDA_Upload1.SetProcessBarBkColor(parseInt('0xFFFFFF'));
    }catch(e){
        alert(e);
    }
}

    var reAtts= new ArrayList();
    var fileurls="";
    var callback = null;
    
        if(parent.addCkEditorAttachment) callback = parent.addCkEditorAttachment;
     

function cbmthod(type,str)
{   
         if(type==0){
        var att= $.parseJSON(str)[0];
    reAtts.add(att);
 fileurls=fileurls+","+att.fileUrl;
    
            
            if(callback){
              callback(att.type, att.filename, att.mimeType, att.createdate, att.size, att.fileUrl,null,null,att.extension,att.icon,att.v);
            }else{
              parent.addAttachment(att.type,  att.filename, att.mimeType,att.createdate, att.size, att.fileUrl,null,null,att.extension,att.icon,att.v);
            }
            
                     
    

     }

    var i=str.indexOf('{');
    if(i==0){
        geniusNum++;
        var str1 = str.split('}');
        var str2 = str.substr(0,str.lastIndexOf('}')+1);//str1[0] + '}'; 
        var str2 = str2.substr(0,str2.lastIndexOf('}')+1);
        var strJsion = '('+str2+')';
        var f = eval(strJsion);
        parent.addAttachment(f.type, f.filename, f.mimeType, f.createDate, f.size, f.fileUrl,null,null,f.extension,f.icon);
        if(geniusNum == number){
            parent.close();
        }

        str = str1[1];

    }
    
    if ( type == 1)
    {
        var percent= document.getElementById("file_percent");
        var fileName=str.substr(str.lastIndexOf("\\")+1);  
        var genNum = geniusNum+1;
        percent.innerText = "共"+number+"个文件，正在上传第"+genNum+"个文件 "+getLimitLength(fileName, 50);
    } 
    else if ( type == -1)
      {
               alert('由于网络不稳定或网络已断开，上传失败！请检查网络，点【确定】重新上传');
               document.getElementById("b1").disabled = false;
      }
    else if ( type == 2){
        var percent= document.getElementById("percent");
        var pcent = str.split('/');
        percent.innerText = "已上传 "+pcent[0]+"KB , 总文件大小 "+pcent[1]+"KB";
    }else if ( type == 100){
        

      parent.window.close();
    }
    return "true";
}

function onUpload(){
  try{
    //如果用户没有选择文件，什么都不做
    if(number != 0){
        $("#b1").disable();
        SetServerName_OnClick();
        show();
        var percent= document.getElementById("result");
        percent.innerText = "";
        var UFIDA_Upload1 = document.getElementById("UFIDA_Upload1");
        UFIDA_Upload1.height = '20';
        var ret = UFIDA_Upload1.StartUpload();   
        if(ret=='-100')
        {
            window.close();
        }
    }
  }catch(e){
    alert(e);
  }
}
</script>
</head>

<body  onkeydown="listenerKeyPress()" style="height: 100%;overflow: hidden" class="page_color">
    <form style="height: 100%;display: block;" enctype="multipart/form-data" name="uploadForm" method="post" id="form_upload" action="/seeyon/fileUpload.do?method=processUpload"   target="uploadIframe">
        <input type="hidden"  id="type" name="type" value="0"> <input type="hidden" name="extensions"
            id="extensions" value=""> <input type="hidden" name="applicationCategory"
            id="applicationCategory" value="1"> <input type="hidden"
            name="destDirectory" id="destDirectory" value=""> <input type="hidden"
            name="destFilename" id="destFilename" value=""> <input type="hidden"
            name="maxSize" id="maxSize" value=""> <input type="hidden" name="isEncrypt"
            id="isEncrypt" value="true"> <input type="hidden" id="form_action"
            value="/seeyon/fileUpload.do"> <input type="hidden" id="fileStr" value="">
        
         
        
         
            <input type="hidden" name="firstSave" id="firstSave" value="true">
        
        
         
        
            <input type="hidden" name="callback" id="callback" value="addCkEditorAttachment">
              
             
        
        
            
            
                <table class="popupTitleRight font_size12" width="100%" height="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
            <td height="20" class="padding_10 font_bold border_b">上传本地文件</td>
        </tr>
        <tr>
            <td class="bg_color_white" align="top" style="padding:0;">
                <div id="scroll_div" style="height:160px;overflow-y:auto;">
                <table width="385" border="0" cellspacing="0" cellpadding="0">
        
        <tr>
            <td height="20" style="background:#fff;">
                 
                <div class="margin_l_10">选择您要上传的文件(单次上传小于50 MB)</div>
            </td>
        </tr>
        <tr>
            <td id="upload1" class="bg-advance-middel padding_10" style="vertical-align: top;background:#fff;">
                <div class="file_box" >
                            <div id="fileInputDiv" style="height: 30px;float:right;width:70px;margin-left:5px;">
                    <div id="fileInputDiv1" style="" class="file_unload clearfix">
                        <a class="common_button common_button_icon file_click" href="###"><em class="ico16 affix_16"></em>添加
                        <INPUT type="file" size="51" name="file1" id="file1" onchange="addNextInput(this)" onkeydown="return false" onkeypress="return false">
                        </a>
                    </div>
                </div>
                
                
                            <ul id="fileNameDiv" class="file_select  border_all clearfix" style="float:left;width:270px;padding:0px 5px;margin:0px;">
                    <li><a>&nbsp;</a></li>
                </ul>
                
                </div>
                
                
            </td>
        </tr>
        <tr id="uploadprocee" style="display:none;">
            <td  style="background:#fff;" align="center" class="bg-advance-middel padding_10">
                <table width="240" height="45" border="0" cellspacing="0" cellpadding="0" >
                  <tr>                  
                    <td align='center' height='30' valign='bottom'>上传中...</td>              
                  </tr>
                  <tr> 
                    <td align='center'><span class='process'>&nbsp;</span></td>
                  </tr>
                </table>
            </td>
        </tr>   
                    </table>
                    </div>
                </td>
            </tr>
        <tr>
            <td height="28" align="right" class="bg-advance-bottom padding_lr_10 border_t">
                <a id="b1" class="common_button common_button_gray" style="cursor: pointer;" onclick="checks()">确定</a>
                <a id="b2" class="common_button common_button_gray" style="cursor: pointer;" onclick="window.close()">取消</a>
                
            </td>
        </tr>
    </table>    

            
        
    </form>
    <iframe name="uploadIframe" frameborder="0" height="0" width="0" class="hidden" style="display:none" scrolling="no" marginheight="0" marginwidth="0"></iframe>
</body>
</html>